<!DOCTYPE html>

<html>

<head>
    
    <link rel="shortcut icon" href="favicon.png" type="image/png">


    <!-- ПОДКЛЮЧЕНИЕ МОДУЛЯ Socket.IO -->
    <script src="/modules/socket.io.js"></script>
    
    <!-- ПОДКЛЮЧЕНИЕ МОДУЛЯ jQuery -->
    <script src="/modules/jquery-3.2.1.min.js"></script>

    <!-- ПОДКЛЮЧЕНИЕ СТИЛЕЙ -->
    <link rel="stylesheet" type="text/css" href="style/main.css">


    <!-- КОНФИГУРАЦИЯ -->
    <meta charset="utf-8" />
    
    <!-- заголовок страницы -->
    <title> Pilot Project </title>



    <!-- WS-КЛИЕНТ -->

    <script>
        
    window.step = 1;

    /*globals $*/
    $(document).ready(function () {

        'use strict';

        /*globals io*/
        window.socket = io.connect('ws://airbonus.azurewebsites.net:8181'); 

        // переменные хранения данных
        var airport_from = [],
            airport_to = [],
            selected_to;

        
        // обработчик нажатия клавиши GO
        $(".button").click(function () {
            
            // очистка ошибок
            $('.error').remove();
            
            // считывание данных с полей
            var data = {
                airport_to: $.trim($('#airport_to').attr("value").toUpperCase()), 
                airport_from: $.trim($('#airport_from').attr("value").toUpperCase()) 
            };
            
            // проверки на отсутствие и повторяемости
            if (airport_from.indexOf(data.airport_from) !== -1 && airport_to.indexOf(data.airport_to) !== -1 && data.airport_from !== data.airport_to) {

                /*globals socket*/
                
                // отправка на сервер начального аэропорта
                socket.emit('setAirportFrom', {
                    'params': {
                        airport: data.airport_from
                    }
                });
                
                // отправка на сервер конечного аэропорта
                socket.emit('setAirportTo', {
                    'params': {
                        airport: data.airport_to
                    }
                });

                $('body').empty();
                
                // редирект на следующую страницу
                $.ajax({
                    url: '2.html',
                    type: "GET",
                    dataType: 'text',
                    success: function (html) {
                        window.step = 2;

                        $('body').css("margin-left", "100%");
                        $('body').html(html);
                        $('body').animate({
                            marginLeft: "0%"
                        }, 200);


                    }
                });

            } else {
                // обработка ошибки
                $('.page').append("<div class='error'>Choose Your From & To Airports!<\/div>");
            }

        });

        // обработчик подсказок начального аэропорта
        $('#airport_from').keyup(function () {

            if ($.trim($('#airport_from').val())) {
                var append = '';

                // запрос от сервера начальных аэропортов
                socket.emit('getAirportsFrom', {
                    line: $.trim($('#airport_from').val())
                });
                
                // обработка от сервера данных со списком начальных аэропортов
                socket.on('getAirportsFrom', function (message) {

                    var count, append = "";

                    for (count = 0; count < message.result.length; count += 1) {
                        airport_from.push(message.result[count].iata);
                    }

                    // формирование списка
                    $('#from-result').empty();
                    
                    for (count = 0; count < message.result.length; count += 1) {
                        append = append + "<li class='result-list' value='" + message.result[count].iata + "'>" + message.result[count].iata + " ( " + message.result[count].name + ", " + message.result[count].city + " ) " + "<\/li>";
                    }
                    
                    $('#from-result').append(append);

                    $('#airport_from').attr({
                        "value": $.trim($('#airport_from').val()).toUpperCase()
                    });

                });

            } else {
                $('#from-result').empty();
            }

        });

        // обработчик подсказок конечного аэропорта
        $('#airport_to').keyup(function () {

            if ($.trim($('#airport_to').val())) {
                
                var append = '';

                socket.emit('getAirportsTo', {
                    line: $.trim($('#airport_to').val())
                });

                socket.on('getAirportsTo', function (message) {

                    var i;

                    for (i = 0; i < message.result.length; i += 1) {
                        airport_to.push(message.result[i].iata);
                    }

                    // формирование списка
                    $('#to-result').empty();
                    
                    for (i = 0; i < message.result.length; i += 1) {
                        append = append + "<li class='result-list' value='" + message.result[i].iata + "'>" + message.result[i].iata + " ( " + message.result[i].name + ", " + message.result[i].city + " ) " + "<\/li>";
                    }
                    
                    $('#to-result').append(append);
                    append = '';

                    $('#airport_to').attr({
                        "value": $.trim($('#airport_to').val()).toUpperCase()
                    });
                });

            } else {
                $('#to-result').empty();
            }

        });
        
        // обработчик выбора начального аэропорта
        $('#from-result').on('click', '.result-list', function () {
            $('#airport_from').val($(this).html());
            $('#airport_from').attr({
                "value": $(this).attr("value").toUpperCase()
            });
            $('#from-result').empty();
        });
        
        // обработчик выбора конечного аэропорта
        $('#to-result').on('click', '.result-list', function () {
            $('#airport_to').val($(this).html());
            $('#airport_to').attr({
                "value": $(this).attr("value").toUpperCase()
            });
            $('#to-result').empty();
        });

    });

    </script>

</head>

<!-- структура основной страницы -->
<body>
        
    <div class="page">
        
        <input type="text" class="border-text" id="airport_from" value="" placeholder="Where from?">
        
        <div id="from-result" class="search-result"></div>
        
        <input type="text" class="border-text" id="airport_to" value="" placeholder="Where to?">
        
        <div id="to-result" class="search-result"></div>

        <button class="button" id="button_p1">Go!</button><br>

    </div>

</body>

</html>
