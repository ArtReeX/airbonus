<!DOCTYPE html>

<html>

<head>

    <!-- заголовок страницы -->
    <title> Pilot Project </title>

    <script>
        if (window.step !== 9) {
            window.location.replace("/");
        } else {

            window.step = 1;
            
            /*globals socket*/
            
            // запрос у сервера рассчитаных данных
            socket.emit('getCalculatedData');
            
            // обработка рассчитаных данных от сервера
            socket.on('getCalculatedData', function (message) {

                'use strict';
                
                /*globals $*/
                $('#preloader').hide();
                $('.page').empty();


                if (message.result.length === 0) {
                    
                    $('.page').html("<div class='text'> Unfortunately, we have no found the cards with bonuses that would make your trip free. Please, check other destination or reduce the minimum number of people for this trip. <\/div><br><br>");
                    
                    $('.page').append('<button class="button-back" id="button-back-p9-sorry">Back<\/button>');
                    
                    return;
                    
                }

                var table = "",
                    // функция проверки на уже добавленную карту в таблице
                    checkUnicue = function (variant, count_one) {
                        
                        var count_two;
                        for (count_two = 0; count_two < count_one; count_two += 1) {
                            
                            if (variant[count_two].card === variant[count_one].card) {
                                return false;
                            }
                            
                        }
                        
                        return true;
                    },
                    count_three,
                    count_four;
                
                for (count_three = 0; count_three < message.result.length; count_three += 1) {

                    table = table + "<div class='text'> Option " + Number(count_three + 1) + ":<\/div><br>";

                    if (message.result[count_three].text) {
                        table = table + "<span class='warning'>" + message.result[count_three].text + "<\/span>";
                    }

                    table = table + " <table id='table'>";
                    table = table + "<tr><th>Card<\/th><th>Airline<\/th><th>From<\/th><th>To<\/th><th>Tickets<\/th><th>Year fee/Amount to spend<\/th><th>Mile<\/th><th>Your card<\/th><\/tr>";

                    for (count_four = 0; count_four < message.result[count_three].variant.length; count_four += 1) {
                        table = table + "<tr>";
                        
                        table = table + "<td><a href='" + message.result[count_three].variant[count_four].link + "'target='_blank'>" + message.result[count_three].variant[count_four].card + "<\/a>" + (!checkUnicue(message.result[count_three].variant, count_four) ? "<\/br>(Same card)" : "");
                        
                        if (message.result[count_three].variant[count_four].image) {
                            table = table + "<br><img id='img-p9' src='http://airbonus.azurewebsites.net:8181/client/images/cards/" + message.result[count_three].variant[count_four].image + "'><\/td>";
                        } else {
                            table = table + "<\/td>";
                        }
                        
                        table = table + "<td>" + message.result[count_three].variant[count_four].airline + "<\/td>";
                        
                        table = table + "<td>" + message.result[count_three].variant[count_four].from + "<\/td>";
                        
                        table = table + "<td>" + message.result[count_three].variant[count_four].to + "<\/td>";
                        
                        table = table + "<td>" + message.result[count_three].variant[count_four].tickets + "<\/td>";
                        
                        if (message.result[count_three].variant[count_four].have) {
                            table = table + "<td>" + "-" + "<\/td>";
                        } else {
                            
                            if (checkUnicue(message.result[count_three].variant, count_four)) {
                                table = table + "<td>" + message.result[count_three].variant[count_four].fee1 + "/" + message.result[count_three].variant[count_four].amount + "<\/td>";
                            } else {
                                table = table + "<td>" + "-" + "<\/td>";
                            }
                        }
                        
                        table = table + "<td>" + message.result[count_three].variant[count_four].mile + "<\/td>";
                        
                        table = table + "<td>" + (message.result[count_three].variant[count_four].have ? 'Yes' : 'No') + "<\/td>";
                        
                        table = table + "<\/tr>";

                    }

                    table = table + "<\/table>";
                    table = table + "<br><br>";
                    $('.page').append(table);
                    table = "";

                }
                
                $('.page').append('<button class="button-back" id="button-back-p9"> Back <\/button><br><br>');

            });
            
            $('.page').on('click', '#button-back-p9, #button-back-p9-sorry', function () {
                
                'use strict';
                
                $('body').empty();
                $.ajax({
                    url: '8.html',
                    type: "GET",
                    dataType: 'text',
                    success: function (html) {
                        window.step = 8;
                        $('body').css("margin-left", "-100%");
                        $('body').html(html);
                        $('body').animate({
                            marginLeft: "0%"
                        }, 200);
                    }
                });
            });

        }

    </script>

</head>

<!-- структура основной страницы -->
<body>
    
    <div class="page">

        <!-- анимация обработки данных на сервере -->
        <div id="preloader"><img src="/style/images/preloader.gif"></div>

    </div>

</body>

</html>
